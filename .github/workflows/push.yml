name: Push
run-name: Push ${{ github.ref_name }}, by ${{ github.actor }}
on:
  push:
    branches:
      - beta
      - stable
jobs:
  run_lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: lts/iron
      - name: Cache
        id: cache-npm
        uses: actions/cache@v4
        env:
          cache-name: cache-node-modules
        with:
          path: ~/.npm
          key: ${{ runner.os }}-cache-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}
      - name: Install dependencies
        run: npm ci
      - name: Lint
        run: npm run lint
  run_unit_test:
    name: Unit test
    runs-on: ubuntu-latest
    services:
      pg:
        image: postgres:alpine
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: lts/iron
      - name: Cache
        id: cache-npm
        uses: actions/cache@v4
        env:
          cache-name: cache-node-modules
        with:
          path: ~/.npm
          key: ${{ runner.os }}-cache-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}
      - name: Install dependencies
        run: npm ci
      - name: Unit test
        env:
          TEST_DB_PASSWORD: postgres
          TEST_DB_HOST: localhost
          TEST_DB_PORT: 5432
          TEST_DB_USER: postgres
          TEST_DB_NAME: postgres
        run: npm run test
  deploy:
    name: Deploy to dev
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
    needs:
      - run_lint
      - run_unit_test
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::126294557793:role/github-action-kiosk-dev
          aws-region: ap-southeast-1
      - name: Setup git
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"
      - uses: actions/setup-node@v4
        with:
          node-version: lts/iron
      - name: Cache
        id: cache-npm
        uses: actions/cache@v4
        env:
          cache-name: cache-node-modules
        with:
          path: ~/.npm
          key: ${{ runner.os }}-cache-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}
      - name: Bump prerelease
        if: github.ref_name == 'beta'
        run: |
          npm version prerelease -m "[skip ci] Release %s" --no-git-tag-version
          git push
      - name: Install dependencies
        run: npm ci
      - name: Deploy to dev
        env:
          COOKIE_SECRET: ${{ secrets.COOKIE_SECRET }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_USER: ${{ secrets.DB_USER }}
          NODE_ENV: production
          S3_CORS_ALLOWED_ORIGIN: https://queue-dev.pranaga.com
          S3_IMAGE_BUCKET: ${{ secrets.S3_IMAGE_BUCKET}}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          TZ: Asia/Jakarta
          VAPID_PRIVATE_KEY: ${{ secrets.VAPID_PRIVATE_KEY }}
          VAPID_PUBLIC_KEY: ${{ secrets.VAPID_PUBLIC_KEY }}
          VITE_S3_BASE_URL: ${{ secrets.VITE_S3_BASE_URL }}
        run: |
          ./node_modules/.bin/cdk deploy
      - name: Reset beta
        if: github.ref_name == 'stable'
        run: |
          git branch -D beta
          git checkout -b beta
          npm version prerelease -m "[skip ci] Release %s" --no-git-tag-version
          git push origin beta --force
